import React, { useEffect, useRef, useState } from "react";
import * as Y from "yjs";
import { WebsocketProvider } from "y-websocket";
import Quill from "quill";
import { QuillBinding } from "y-quill";
import "quill/dist/quill.snow.css";

type Props = {
  docId: string;
};

export default function Editor({ docId }: Props) {
  const editorRef = useRef<HTMLDivElement | null>(null);
  const [awarenessUsers, setAwarenessUsers] = useState<any[]>([]);
  const providerRef = useRef<WebsocketProvider | null>(null);
  const ydocRef = useRef<Y.Doc | null>(null);

  useEffect(() => {
    const savedToken = typeof window !== "undefined" ? localStorage.getItem("token") : null;
    const username = savedToken ? JSON.parse(atob(savedToken.split(".")[1])).name : `guest-${Math.floor(Math.random() * 1000)}`;

    // Create a Yjs document and connect to y-websocket server
    const ydoc = new Y.Doc();
    ydocRef.current = ydoc;

    const wsUrl = (process.env.NEXT_PUBLIC_WS_URL || "ws://localhost:1234").replace(/^http/, "ws");
    const provider = new WebsocketProvider(wsUrl, `document-${docId}`, ydoc, {
      // Provide token as query param (demo only). Production: upgrade to bearer token in subprotocol or cookie via wss.
      params: { token: savedToken || "" },
    });
    providerRef.current = provider;

    // Awareness: user metadata shown in participants list (name, color, cursor)
    provider.awareness.setLocalStateField("user", {
      name: username,
      color: "#"+Math.floor(Math.random()*16777215).toString(16),
    });

    // Create a Quill editor and bind it to Yjs text type
    const ytext = ydoc.getText("quill");
    const editorDiv = document.createElement("div");
    editorDiv.style.flex = "1";
    editorDiv.style.padding = "16px";
    editorRef.current?.appendChild(editorDiv);

    const quill = new Quill(editorDiv, { theme: "snow" });

    // Keep a binding for collaborative edits
    const binding = new QuillBinding(ytext, quill, provider.awareness);

    // Update awareness user list on changes
    const awarenessChange = () => {
      const states = Array.from(provider.awareness.getStates().values()).map((s: any) => s.user).filter(Boolean);
      setAwarenessUsers(states);
    };
    provider.awareness.on("change", awarenessChange);
    awarenessChange();

    // Clean up on unmount
    return () => {
      binding.destroy();
      provider.destroy();
      ydoc.destroy();
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [docId]);

  return (
    <div style={{ display: "flex", flex: 1 }}>
      <div style={{ width: 220, borderRight: "1px solid #eee", padding: 12 }}>
        <h3>Participants</h3>
        <ul>
          {awarenessUsers.map((u, idx) => (
            <li key={idx}>
              <span style={{ display: "inline-block", width: 10, height: 10, background: u.color, marginRight: 8 }}></span>
              {u.name || "anonymous"}
            </li>
          ))}
        </ul>
      </div>
      <div style={{ flex: 1, padding: 12 }}>
        <div ref={editorRef} style={{ height: "100%", display: "flex", flexDirection: "column" }} />
      </div>
    </div>
  );
}
